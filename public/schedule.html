<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Current RMS – Staff Schedule</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 4px 8px; text-align: center; }
    th.sticky-top { position: sticky; top: 0; background: #f7f7f7; z-index: 2; }
    th.sticky-left, td.sticky-left { position: sticky; left: 0; background: #fff; z-index: 1; }
    th.sticky-top.sticky-left { z-index: 3; }
    .assigned { font-weight: bold; }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
    .controls label { display: flex; gap: 4px; align-items: center; }
  </style>
</head>
<body>
  <h1>Staff vs Job Schedule</h1>

  <div class="controls">
    <label>
      Start:
      <input type="date" id="start">
    </label>
    <label>
      End:
      <input type="date" id="end">
    </label>
    <button id="load">Load</button>

    <label>
      Crew:
      <select id="crewFilter">
        <option value="all">All crew</option>
        <option value="assigned">Only crew on shown jobs</option>
      </select>
    </label>

    <span id="status"></span>
  </div>

  <div id="table-container"></div>

  <script>
    const apiBase = ''; // same origin

    let currentData = null;
    let currentFilter = 'all';

    const loadBtn = document.getElementById('load');
    const crewFilterSelect = document.getElementById('crewFilter');
    const statusEl = document.getElementById('status');
    const container = document.getElementById('table-container');

    loadBtn.addEventListener('click', loadSchedule);
    crewFilterSelect.addEventListener('change', () => {
      currentFilter = crewFilterSelect.value;
      if (currentData) {
        renderTable(currentData, container);
      }
    });

    async function loadSchedule() {
      const start = document.getElementById('start').value;
      const end = document.getElementById('end').value;

      if (!start || !end) {
        alert("Pick a start and end date first");
        return;
      }

      statusEl.textContent = "Loading...";
      container.innerHTML = "";

      try {
        const res = await fetch(`${apiBase}/api/schedule?start=${start}&end=${end}`);
        if (!res.ok) throw new Error("Request failed: " + res.status);

        const data = await res.json();
        currentData = data; // remember last data so filter can re-render
        renderTable(data, container);

        statusEl.textContent = `Loaded ${data.jobs.length} jobs and ${data.staff.length} crew.`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error loading data.";
      }
    }

    function renderTable(data, container) {
      const { jobs, staff, assignments } = data;

      container.innerHTML = "";

      if (!jobs || jobs.length === 0) {
        container.textContent = "No jobs found.";
        return;
      }

      // Decide which crew to show based on filter
      let staffToShow = staff || [];

      if (currentFilter === 'assigned') {
        const usedIds = new Set();

        // collect all staff ids that are on at least one job in this data set
        jobs.forEach(job => {
          const staffIds = assignments[job.id] || assignments[String(job.id)] || [];
          staffIds.forEach(id => usedIds.add(id));
        });

        staffToShow = staffToShow.filter(s => usedIds.has(s.id));
      }

      // If after filtering there are no staff, show a message
      if (!staffToShow.length) {
        container.textContent = "No crew match this filter.";
        return;
      }

      const table = document.createElement("table");

      // Header
      const thead = document.createElement("thead");
      const headRow = document.createElement("tr");

      const corner = document.createElement("th");
      corner.textContent = "Job / Staff";
      corner.classList.add("sticky-top", "sticky-left");
      headRow.appendChild(corner);

      staffToShow.forEach(s => {
        const th = document.createElement("th");
        th.textContent = s.name;
        th.classList.add("sticky-top");
        headRow.appendChild(th);
      });

      thead.appendChild(headRow);
      table.appendChild(thead);

      // Body
      const tbody = document.createElement("tbody");

      jobs.forEach(job => {
        const row = document.createElement("tr");

        const jobCell = document.createElement("td");
        jobCell.classList.add("sticky-left");
        const dates = [job.starts_at, job.ends_at].filter(Boolean).join(" → ");
        jobCell.innerHTML = `<strong>${job.name}</strong><br><small>${dates}</small>`;
        row.appendChild(jobCell);

        staffToShow.forEach(s => {
          const td = document.createElement("td");
          const staffIds = assignments[job.id] || assignments[String(job.id)] || [];
          const isAssigned = staffIds.includes(s.id);
          td.textContent = isAssigned ? "✔" : "";
          if (isAssigned) td.classList.add("assigned");
          row.appendChild(td);
        });

        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      container.appendChild(table);
    }
  </script>
</body>
</html>
